define(['jquery'], function($) {
    return {
        init: function(speid, sesskey) {
            let timeout;
            const form = $('.mform'); 
            console.log("Auto-save draft initialized for SPE ID:", speid);
            form.on('input change', function () {
                console.log("Form changed, scheduling auto-save...");
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    console.log("Auto-saving draft...");
                    const data = form.serialize();

                    $.post(M.cfg.wwwroot + '/mod/smartspe/student/savedraft.php', {
                        speid: speid,
                        sesskey: sesskey,
                        data: data
                    })
                    .done(function (response) {
                         console.log('Draft saved:', response);
                    })
                    .fail(function(xhr) {
                        console.error('Save failed:', xhr.responseText);
                    });
                }, 3000); // Save every 3s after idle
            });
        }
    };
});
